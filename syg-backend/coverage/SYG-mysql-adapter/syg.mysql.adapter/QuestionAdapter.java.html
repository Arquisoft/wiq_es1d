<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>QuestionAdapter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">SYG_bootstrap</a> &gt; <a href="../index.html" class="el_bundle">SYG-mysql-adapter</a> &gt; <a href="index.source.html" class="el_package">syg.mysql.adapter</a> &gt; <span class="el_source">QuestionAdapter.java</span></div><h1>QuestionAdapter.java</h1><pre class="source lang-java linenums">package syg.mysql.adapter;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import syg.domain.exception.NotFoundException;
import syg.domain.model.Answer;
import syg.domain.model.Question;
import syg.domain.model.WikiData;
import syg.domain.model.enums.CategoryEnum;
import syg.domain.ports.outbounds.QuestionPersistence;
import syg.mysql.entities.AnswerEntity;
import syg.mysql.entities.CategoryEntity;
import syg.mysql.entities.QuestionEntity;
import syg.mysql.mapper.AnswerMapper;
import syg.mysql.mapper.QuestionMapper;
import syg.mysql.repositories.CategoryRepository;
import syg.mysql.repositories.QuestionRepository;

@Component
<span class="fc" id="L25">public class QuestionAdapter implements QuestionPersistence {</span>

	@Autowired
	private QuestionRepository questionRepository;

	@Autowired
	private CategoryRepository categoryRepository;

	@Autowired
	private QuestionMapper questionMapper;

	@Autowired
	private AnswerMapper answerMapper;

	@Autowired
	private WikiData wikiData;

	@Override
	public List&lt;Question&gt; findAll() {
<span class="fc" id="L44">		return questionMapper.toDomain(questionRepository.findAll());</span>
	}

	@Override
	public Question findById(Long id) {
<span class="fc" id="L49">		Optional&lt;QuestionEntity&gt; optionalQuestion = questionRepository.findById(id);</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">		if (!optionalQuestion.isPresent()) {</span>
<span class="fc" id="L51">			throw new NotFoundException(&quot;The question with id &quot; + id + &quot; does not exist&quot;);</span>
		}
<span class="fc" id="L53">		return questionMapper.toDomain(questionRepository.findById(id).get());</span>
	}

	@Override
	public List&lt;Question&gt; findByCategory(Long categoryId) {
<span class="fc" id="L58">		return questionMapper.toDomain(questionRepository.findByCategory_Id(categoryId));			</span>
	}
	
	@Override
	public void deleteQuestions() {
<span class="nc" id="L63">		questionRepository.deleteAll();</span>
<span class="nc" id="L64">	}</span>

	@Override
	public void generatedQuestions() {
<span class="nc" id="L68">		List&lt;CategoryEntity&gt; categoriesEntities = categoryRepository.findAll();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">		for (CategoryEnum categoryEnum : CategoryEnum.values()) {</span>
<span class="nc" id="L70">			CategoryEntity category = null;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">			for (CategoryEntity categoryEntity : categoriesEntities) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">				if (categoryEntity.getName().equals(categoryEnum.getLabel())) {</span>
<span class="nc" id="L73">					category = categoryEntity;</span>
<span class="nc" id="L74">					break;</span>
				}
<span class="nc" id="L76">			}</span>

<span class="nc" id="L78">			String sparqlQuery = String.format(WikiData.WIKIDATA_QUERY, categoryEnum.getValue());</span>
<span class="nc" id="L79">			List&lt;WikiData&gt; responses = wikiData.executeSparqlQuery(sparqlQuery);</span>

<span class="nc" id="L81">			List&lt;QuestionEntity&gt; questions = generatedQuestionsLogic(responses, category);</span>
<span class="nc" id="L82">			questionRepository.saveAll(questions);</span>
		}
<span class="nc" id="L84">	}</span>

	/**
	 * Genera las preguntas, con sus respuestas incorrecta.
	 * Las forma de manera totalmente al azar, para que no se repitan nunca.
	 * 
	 * @param wikisQuestions Las preguntas generadas
	 * @param categoryEntity La categoria a la que pertencen
	 * @return
	 */
	private List&lt;QuestionEntity&gt; generatedQuestionsLogic(List&lt;WikiData&gt; wikisQuestions, CategoryEntity categoryEntity) {
<span class="nc" id="L95">		List&lt;QuestionEntity&gt; questionsGenerated = new ArrayList&lt;QuestionEntity&gt;();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">		for (int i = 0; i &lt; wikisQuestions.size(); i++) {</span>
<span class="nc" id="L97">			Question question = new Question(wikisQuestions.get(i).getDescription().substring(0, 1).toUpperCase()</span>
<span class="nc" id="L98">					+ wikisQuestions.get(i).getDescription().substring(1));</span>
<span class="nc" id="L99">			List&lt;Answer&gt; answers = new ArrayList&lt;Answer&gt;();</span>
<span class="nc" id="L100">			Answer correctAnswer = new Answer(wikisQuestions.get(i).getResponse().substring(0, 1).toUpperCase()</span>
<span class="nc" id="L101">					+ wikisQuestions.get(i).getResponse().substring(1), true);</span>
			
<span class="nc" id="L103">			List&lt;Integer&gt; incorrectResponses = wikiData.generateUniqueRandomIndex(wikisQuestions.size(), i, 3);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			for (Integer incorrectResponseIndex : incorrectResponses) {</span>
<span class="nc" id="L105">				answers.add(new Answer(wikisQuestions.get(incorrectResponseIndex).getResponse(), false));</span>
<span class="nc" id="L106">			}</span>
<span class="nc" id="L107">			answers.add(correctAnswer);</span>

<span class="nc" id="L109">			QuestionEntity questionEntity = questionMapper.toEntity(question);</span>
<span class="nc" id="L110">			questionEntity.setCategory(categoryEntity);</span>
<span class="nc" id="L111">			List&lt;AnswerEntity&gt; answersEntities = answerMapper.toEntity(answers);</span>
<span class="nc" id="L112">			answersEntities.stream().forEach(answer -&gt; answer.setQuestion(questionEntity));</span>
<span class="nc" id="L113">			questionEntity.setAnswers(answersEntities);</span>
<span class="nc" id="L114">			questionsGenerated.add(questionEntity);</span>
		}
<span class="nc" id="L116">		return questionsGenerated;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>